<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <!-- Slide meta data, remove/edit as you see fit -->
    <title>OpenFlow Framework Trema, hands-on session</title>
    <meta content='Yasuhito Takamiya' name='author' />
    <meta content='yasuhito@gmail.com' name='email' />
    <meta content='November 9, 2011' name='date' />
    <!-- Slippy core file and dependencies -->
    <script src='slippy/src/jquery.min.js' type='text/javascript'></script>
    <script src='slippy/src/jquery.history.js' type='text/javascript'></script>
    <script src='slippy/src/slippy.js' type='text/javascript'></script>
    <!-- Slippy structural styles -->
    <link href='slippy/src/slippy.css' rel='stylesheet' type='text/css' />
    <!-- Trema theme -->
    <link href='trema.css' rel='stylesheet' type='text/css' />
    <!-- Syntax highlighting core file -->
    <script src='slippy/src/highlighter/shCore.js' type='text/javascript'></script>
    <!-- Syntax highlighting brushes, remove those you don't need -->
    <script src='slippy/src/highlighter/shBrushBash.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushCpp.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushCSharp.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushCss.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushDelphi.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushDiff.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushGroovy.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushJava.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushJScript.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushPhp.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushPlain.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushPython.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushRuby.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushScala.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushSql.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushVb.js' type='text/javascript'></script>
    <script src='slippy/src/highlighter/shBrushXml.js' type='text/javascript'></script>
    <!-- Syntax highlighting styles -->
    <link href='slippy/src/highlighter/shCore.css' rel='stylesheet' type='text/css' />
    <link href='slippy/src/highlighter/shThemeDefault.css' rel='stylesheet' type='text/css' />
    <!-- Slippy init code -->
    <script type='text/javascript'>
      //<![CDATA[
        $(function() {
            $(".slide").slippy({
                // settings go here
                // possible values are:
                //  - animLen, duration for default animations (0 = disabled)
                //  - animInForward, receives a slide and animates it
                //  - animInRewind, receives a slide and animates it
                //  - animOutForward, receives a slide and animates it
                //  - animOutRewind, receives a slide and animates it
                //  - baseWidth, defines the base for img resizing, if you don't want only
                //    full-width images, specify this as the pixel width of a slide so that
                //    images are scaled properly (default is 620px wide)
                //  - ratio, defines the width/height ratio of the slides, defaults to 1.3 (620x476)
                //  - margin, the fraction of screen to use as slide margin, defaults to 0.15
            });
            SyntaxHighlighter.all();
        });
      //]]>
    </script>
    <!-- Custom style for this deck -->
    <style type='text/css'>
      /*<![CDATA[*/
        .slide.nofooter {
          border: 0;
          background: 0;
        }
      /*]]>*/
    </style>
  </head>
  <body>
    <div class='slide'>
      <div class='vcenter'>
        <br />
        <h2>OpenFlow Framework Trema</h2>
        <h2>Hands-on Tutorial</h2>
        <br />
        <br />
        <br />
        <p>
          Hideyuki Shimonishi
          <a href='http://twitter.com/hide_shimonishi'>@hide_shimonishi</a>
          <br />
          Yasuhito Takamiya
          <a href='http://twitter.com/yasuhito'>@yasuhito</a>
          <br />
          Kazushi Sugyo
          <br />
          NEC
          <br />
          <br />
          <p>CHANGE & OFELIA Summer School</p>
          <p>November 9, 2011</p>
        </p>
      </div>
    </div>
    <div class='slide'>
      <h1>Agenda</h1>
      <ul>
        <li>Introduction and design condept</li>
        <li>Hands-on coding</li>
        <li>Summary</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>We are...</h1>
      <p>Trema team from NEC laboratories</p>
      <ul>
        <li>Hideyuki (Networking Ninja)</li>
        <li>Yasuhito (HPC and Middleware)</li>
        <li>Kazushi (KAME: IPv6 stack for *BSD)</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Q: Why Framework?</h1>
      <p>
        <b>A: High productivity (e.g., Rails)</b>
      </p>
      <ul>
        <li>"common operations" can be written in short</li>
        <li>Full-stack: develop with your laptop</li>
      </ul>
      <br />
      <p>â†’ Tight loops of "coding, testing, and debugging"</p>
      <p>
        <span style='background-color: #ffff00'>...And there were no such programming framework in OpenFlow yet.</span>
      </p>
    </div>
    <div class='slide'>
      <h1>Features of Trema Framework</h1>
      <p>
        <span style='background-color: #ffff00'>Most "modern" framework for OpenFlow</span>
      </p>
      <ul>
        <li>Ruby or C (Ruby's productivity + C's speed)</li>
        <li>Full-stack: develop with your laptop</li>
        <li>Open development process on github (GPL2)</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Voices from Experts</h1>
      <p>
        <i>"I poked through Trema recently.  It looks like a *great* project. Very clean."</i>
        <i>(openflow-discuss list)</i>
      </p>
      <div class='right'>
        <p>Martin Casado (Nicira CTO)</p>
      </div>
    </div>
    <div class='slide'>
      <h1>Trema Design Concept</h1>
      <div class='vcenter'>
        <h1>"Write it short, run it quickly"</h1>
      </div>
    </div>
    <div class='slide'>
      <h1>Trema Design Concept</h1>
      <div class='vcenter'>
        <h1>
          "
          <span style='background-color: #ffff00'>Write it short,</span>
          run it quickly"
        </h1>
      </div>
    </div>
    <div class='slide'>
      <h1>Why short code?</h1>
      <p>If you can keep your code short,</p>
      <ul>
        <li>more quickly you can finish your product,</li>
        <li>less incidence of software bugs,</li>
        <li>and easier to maintainance your code.</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Example: Trema repeater-hub</h1>
      <pre class='brush: ruby; highlight: [3, 8]'>class RepeaterHub < Controller&#x000A;  def packet_in datapath_id, message&#x000A;    send_flow_mod_add(&#x000A;      datapath_id,&#x000A;      :match => ExactMatch.from( message ),&#x000A;      :actions => ActionOutput.new( OFPP_FLOOD )&#x000A;    )&#x000A;    send_packet_out(&#x000A;      datapath_id,&#x000A;      :packet_in => message,&#x000A;      :actions => ActionOutput.new( OFPP_FLOOD )&#x000A;    )&#x000A;  end&#x000A;end</pre>
      <p>
        Very concise, and there are only a few essential pieces (flow_mod + FLOOD) in this code.
      </p>
    </div>
    <div class='slide'>
      <h1>Let's compare Trema with</h1>
      <ul>
        <li>NOX (Python binding)</li>
        <li>Beacon (Java)</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>NOX (Python binding)</h1>
      <p>Redundant code!</p>
      <pre class='brush: python; highlight: [2, 8, 17]'>class pyswitch(Component):&#x000A;    def __init__(self, ctxt):&#x000A;        global inst&#x000A;        Component.__init__(self, ctxt)&#x000A;        self.st = {}&#x000A;        inst = self&#x000A;&#x000A;    def install(self):&#x000A;        inst.register_for_packet_in(packet_in_callback)&#x000A;        inst.register_for_datapath_leave(datapath_leave_callback)&#x000A;        inst.register_for_datapath_join(datapath_join_callback)&#x000A;        inst.post_callback(1, timer_callback)&#x000A;&#x000A;    def getInterface(self):&#x000A;        return str(pyswitch)&#x000A;&#x000A;    def getFactory():&#x000A;        class Factory:&#x000A;            def instance(self, ctxt):&#x000A;                return pyswitch(ctxt)&#x000A;        return Factory()&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Beacon (Java)</h1>
      <p>We don't use Java :-) (static typing system WITHOUT good type inference mechanism makes your code looong!)</p>
      <div align='center'>
        <img height='60%' src='./static-typing.gif' />
      </div>
    </div>
    <div class='slide'>
      <h1>Trema Design Concept</h1>
      <div class='vcenter'>
        <h1>
          "Write it short,
          <span style='background-color: #ffff00'>run it quickly</span>
          "
        </h1>
      </div>
    </div>
    <div class='slide'>
      <h1>Pains of OpenFlow development</h1>
      <p>
        <i>"I don't have a OpenFlow switch."</i>
      </p>
      <br />
      <p>
        <i>"It is complicated to setup OpenFlow development environment (network configurations and VM installations etc.)"</i>
      </p>
      <br />
      <p>
        <i>"There are no network environments here usable for OpenFlow experiments."</i>
      </p>
      <div class='right'>
        <p>Anonymous programmer</p>
      </div>
    </div>
    <div class='slide'>
      <h1>Trema Works with No Pain</h1>
      <p>
        You can build a virtual network on your laptop and test your own controllers on it.
      </p>
      <ul>
        <li>Run your controller without modifications</li>
        <li>Send and receive test packets between virtual hosts</li>
        <li>Dump packets and flow-tables etc.</li>
      </ul>
      <br />
      <p class='right'>See how it works...</p>
    </div>
    <div class='slide'>
      <div class='vcenter'>
        <h1>Hands-on Coding Section</h1>
        <h1>Walk-Through of Development with Trema</h1>
      </div>
    </div>
    <div class='slide'>
      <h1>Let's Setup Trema!</h1>
      <pre class='brush: plain'>$ git clone git://github.com/trema/trema.git&#x000A;$ ./trema/build.rb</pre>
      <p>
        <span style='background-color: #ffff00'>And there are no step three!</span>
      </p>
    </div>
    <div class='slide'>
      <h1>Coding #1: Your first controller</h1>
      <p>
        Define a controller as a class and make it derived from
        <span style='background-color: #ffff00'>Controller class</span>
      </p>
      <pre class='brush: ruby'># simple.rb&#x000A;class SimpleController < Controller&#x000A;end</pre>
      <br />
      <p>
        Run it with
        <span style='background-color: #ffff00'>trema run</span>
        command:
      </p>
      <pre class='brush: plain'>% ./trema run ./simple.rb&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Coding #2: Hello Trema!</h1>
      <p>
        Add a
        <span style='background-color: #ffff00'>start method</span>
        to the controller class.
      </p>
      <pre class='brush: ruby; highlight: [3,4,5]'># hello.rb&#x000A;class HelloController < Controller&#x000A;  def start&#x000A;    puts "Hello, Trema!"&#x000A;  end&#x000A;end</pre>
      <p>It is a hook method invoked at startup (initializer).</p>
      <br />
      <p>You can run it with trema run</p>
      <pre class='brush: ruby; highlight: [2]'>% ./trema run ./hello.rb&#x000A;Hello, Trema!&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Class in Ruby</h1>
      <pre class='brush: ruby'>class ClassName < SuperClassName&#x000A;  def method_name arg1, arg2&#x000A;    # method body&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Coding #3: Switch Monitor</h1>
      <p>Switch monitor tracks all switches in a network</p>
      <ul>
        <li>Updates the list of switches in real-time</li>
        <li>Notifies when a new switch is UP</li>
        <li>Notifies when a switch becomes DOWN</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Coding #3: Switch Monitor</h1>
      <pre class='brush: ruby'># src/examples/switch_monitor/switch-monitor.rb&#x000A;class SwitchMonitor < Controller&#x000A;  periodic_timer_event :show_switches, 10&#x000A;&#x000A;  def start&#x000A;    @switches = []&#x000A;  end&#x000A;&#x000A;  def switch_ready datapath_id&#x000A;    @switches << datapath_id.to_hex&#x000A;    info "Switch #{ datapath_id.to_hex } is UP"&#x000A;  end&#x000A;&#x000A;  def switch_disconnected datapath_id&#x000A;    @switches -= [ datapath_id.to_hex ]&#x000A;    info "Switch #{ datapath_id.to_hex } is DOWN"&#x000A;  end&#x000A;&#x000A;  private&#x000A;&#x000A;  def show_switches&#x000A;    info "All switches = " + @switches.sort.join( ", " )&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Event Handlers</h1>
      <pre class='brush: ruby; highlight: [9,10,11,12,14,15,16,17]'># src/examples/switch_monitor/switch-monitor.rb&#x000A;class SwitchMonitor < Controller&#x000A;  periodic_timer_event :show_switches, 10&#x000A;&#x000A;  def start&#x000A;    @switches = []&#x000A;  end&#x000A;&#x000A;  def switch_ready datapath_id&#x000A;    @switches << datapath_id.to_hex&#x000A;    info "Switch #{ datapath_id.to_hex } is UP"&#x000A;  end&#x000A;&#x000A;  def switch_disconnected datapath_id&#x000A;    @switches -= [ datapath_id.to_hex ]&#x000A;    info "Switch #{ datapath_id.to_hex } is DOWN"&#x000A;  end&#x000A;&#x000A;  private&#x000A;&#x000A;  def show_switches&#x000A;    info "All switches = " + @switches.sort.join( ", " )&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>switch_ready handler</h1>
      <pre class='brush: ruby; highlight: [8,9,10,11]'>class SwitchMonitor < Controller&#x000A;  periodic_timer_event :show_switches, 10&#x000A;&#x000A;  def start&#x000A;    @switches = []&#x000A;  end&#x000A;&#x000A;  def switch_ready datapath_id&#x000A;    @switches << datapath_id.to_hex&#x000A;    info "Switch #{ datapath_id.to_hex } is UP"&#x000A;  end</pre>
      <ul>
        <li>When a switch is connected to the controller, add (<<) its dpid to the switch-list instance variable (@switches)</li>
        <li>Then output like "Switch 0xabc is UP"</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>List in Ruby</h1>
      <pre class='brush: ruby'>% irb&#x000A;> zoo = []&#x000A;=> []&#x000A;&#x000A;> zoo << "bat"&#x000A;=> ["bat"]&#x000A;&#x000A;> zoo << "gnu"&#x000A;=> ["bat", "gnu"]&#x000A;&#x000A;> zoo << "dog"&#x000A;=> ["bat", "gnu", "dog"]&#x000A;&#x000A;> zoo -= ["bat"]&#x000A;=> ["gnu", "dog"]&#x000A;&#x000A;> zoo.sort&#x000A;=> ["dog", "gnu"]</pre>
      <p>irb = interactive ruby (REPL)</p>
    </div>
    <div class='slide'>
      <h1>switch_disconnected handler</h1>
      <ul>
        <li>
          When a switch becomes DOWN, remove (-=) its dpid from @switches list
        </li>
        <li>Then output like "Switch 0xabc is DOWN"</li>
      </ul>
      <pre class='brush: ruby; highlight: [6,7,8,9]'># src/examples/switch_monitor/switch-monitor.rb&#x000A;class SwitchMonitor < Controller&#x000A;&#x000A;    ...&#x000A;&#x000A;  def switch_disconnected datapath_id&#x000A;    @switches -= [ datapath_id.to_hex ]&#x000A;    info "Switch #{ datapath_id.to_hex } is DOWN"&#x000A;  end&#x000A;&#x000A;    ...&#x000A;&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>show_switches timer handler</h1>
      <ul>
        <li>Output the switch list like "All switches = 0xabc, 0xdef, ..." in every 10 seconds</li>
        <li>periodic_timer_handler registers show_switches method as a timer handler</li>
      </ul>
      <pre class='brush: ruby; highlight: [2,6,7,8]'>class SwitchMonitor < Controller&#x000A;  periodic_timer_event :show_switches, 10&#x000A;&#x000A;    ...&#x000A;&#x000A;  def show_switches&#x000A;    info "All switches = " + @switches.sort.join( ", " )&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Run Switch Monitor</h1>
      <p>Write a virtual network configuration (DSL) that adds three switches to the network.</p>
      <pre class='brush: ruby'># src/examples/switch_monitor/switch-monitor.conf&#x000A;vswitch { datapath_id 0x1 }&#x000A;vswitch { datapath_id 0x2 }&#x000A;vswitch { datapath_id 0x3 }&#x000A;</pre>
      <p>
        Then pass it to trema run with
        <span style='background-color: #ffff00'>-c</span>
        option
      </p>
      <pre class='brush: plain'>% ./trema run ./src/examples/switch_monitor/switch-monitor.rb -c ./src/examples/switch_monitor/switch-monitor.conf&#x000A;Switch 0x3 is UP&#x000A;Switch 0x2 is UP&#x000A;Switch 0x1 is UP&#x000A;All switches = 0x1, 0x2, 0x3&#x000A;All switches = 0x1, 0x2, 0x3&#x000A;All switches = 0x1, 0x2, 0x3&#x000A;  ...&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Virtual Network DSL</h1>
      <ul>
        <li>You can build arbitrally network topology on your laptop and run your controlller on it.</li>
        <li>Debug your controller by sending and receiving test packets between virtual hosts.</li>
        <li>You can use virtual switch, host, and link to construct the virtual network.</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Shutdown a Switch</h1>
      <p>Let's test switch_disconnected handler by causing a fault in the virtual network</p>
      <br />
      <p>
        Open another terminal and run
        <span style='background-color: #ffff00'>trema kill</span>
      </p>
      <pre class='brush: bash'>% ./trema kill 0x3&#x000A;</pre>
      <br />
      <p>Then you can see "Switch 0x??? is DOWN"</p>
      <pre class='brush: ruby; highlight: [9]'>% ./trema run ./switch-monitor.rb -c ./switch-monitor.conf&#x000A;Switch 0x3 is UP&#x000A;Switch 0x2 is UP&#x000A;Switch 0x1 is UP&#x000A;All switches = 0x1, 0x2, 0x3&#x000A;All switches = 0x1, 0x2, 0x3&#x000A;All switches = 0x1, 0x2, 0x3&#x000A;  ...&#x000A;Switch 0x3 is DOWN&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Summary: Switch Monitor</h1>
      <ul>
        <li>Implement the logic of a controller by adding event handlers (e.g., switch_ready and switch_disconnected)</li>
        <li>Network DSL makes it possible to test your own controller even if you don't have OpenFlow switches.</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Coding #4: packet-in handling</h1>
      <p>Add the following method to handle packet-in</p>
      <pre class='brush: ruby; highlight: [2,3,4]'>class SimpleController < Controller&#x000A;  def packet_in dpid, message&#x000A;    puts "New packet_in message!"&#x000A;  end&#x000A;    ...</pre>
      <ul>
        <li>dpid: the datapath ID of the switch that received a packet-in</li>
        <li>message: packet-in message object</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Let's Send Packets!</h1>
      <p>Firstly, you must add virtual hosts to send/receive packets and connect them to a virtual switch:</p>
      <pre class='brush: ruby'>vswitch { dpid 0xabc }&#x000A;&#x000A;# Add two virtual hosts&#x000A;vhost("host1") {&#x000A;  mac "00:00:00:00:00:01"&#x000A;}&#x000A;vhost("host2") {&#x000A;  mac "00:00:00:00:00:02"&#x000A;}&#x000A;&#x000A;# connect hosts to a switch&#x000A;link "0xabc", "host1"&#x000A;link "0xabc", "host2"&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Let's Send Packets!</h1>
      <ul>
        <li>Send test packets with send_packets</li>
        <li>The following will send ten packets from host1 to host2 in a second</li>
      </ul>
      <pre class='brush: plain'>% ./trema send_packets --source host1 --dest host2 --n_pkts 10 --pps 10&#x000A;New packet_in message!&#x000A;New packet_in message!&#x000A;New packet_in message!&#x000A;New packet_in message!&#x000A;New packet_in message!&#x000A;  ...&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Large and complex topology?</h1>
      <p>Ten switches full-mesh topology configurations in flat (about 80 LOC)</p>
      <pre class='brush: ruby'>vswitch { dpid "0x1" }&#x000A;vswitch { dpid "0x2" }&#x000A;vswitch { dpid "0x3" }&#x000A;vswitch { dpid "0x4" }&#x000A;  ...&#x000A;&#x000A;link "0x1", "0x2"&#x000A;link "0x1", "0x3"&#x000A;link "0x1", "0x4"&#x000A;link "0x1", "0x5"&#x000A;link "0x1", "0x6"&#x000A;link "0x1", "0x7"&#x000A;link "0x1", "0x8"&#x000A;link "0x1", "0x9"&#x000A;link "0x1", "0x10"&#x000A;link "0x2", "0x3"&#x000A;link "0x2", "0x4"&#x000A;  ...&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Advanced DSL Usage</h1>
      <ul>
        <li>You can use full Ruby syntax in the DSL</li>
        <li>the full-mesh topology can be rewritten briefly with nested loops:</li>
      </ul>
      <pre class='brush: ruby'>$nswitch = 10&#x000A;&#x000A;1.upto( $nswitch ).each do | sw1 |&#x000A;  vswitch { dpid sw1.to_hex }&#x000A;&#x000A;  1.upto( $nswitch ).each do | sw2 |&#x000A;    link sw1.to_hex, sw2.to_hex if sw1 < sw2&#x000A;  end&#x000A;end</pre>
      <p>Very concise!</p>
    </div>
    <div class='slide'>
      <h1>Coding #5: Modifying flow-table</h1>
      <p>Write a flow-entry that forwards incoming packets to the next switch port</p>
      <pre class='brush: ruby; highlight: [3,4,5,6,7,8]'>class SimpleController < Controller&#x000A;  def packet_in dpid, message&#x000A;    send_flow_mod_add(&#x000A;      dpid,&#x000A;      :match => ExactMatch.from( message ),&#x000A;      :buffer_id => message.buffer_id,&#x000A;      :actions => ActionOutput.new( message.in_port + 1 )&#x000A;    )&#x000A;  end&#x000A;end</pre>
      <p>Very concise!</p>
    </div>
    <div class='slide'>
      <h1>Comparison of flow_mod API</h1>
      <p>Trema</p>
      <pre class='brush: ruby'>send_flow_mod_add(&#x000A;  dpid,&#x000A;  :match => ExactMatch.from( message ),&#x000A;  :buffer_id => message.buffer_id,&#x000A;  :actions => ActionOutput.new( message.in_port + 1 )&#x000A;)&#x000A;</pre>
      <p>NOX</p>
      <pre class='brush: python'>inst.install_datapath_flow(&#x000A;  dpid,&#x000A;  extract_flow(packet),&#x000A;  CACHE_TIMEOUT, &#x000A;  openflow.OFP_FLOW_PERMANENT,&#x000A;  [[openflow.OFPAT_OUTPUT, [0, prt[0]]]],&#x000A;  bufid,&#x000A;  openflow.OFP_DEFAULT_PRIORITY,&#x000A;  inport,&#x000A;  buf&#x000A;)&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Creating a Match Structure</h1>
      <p>You can easily create an exact match from incoming packet_in message:</p>
      <pre class='brush: ruby; highlight: [3]'>send_flow_mod_add(&#x000A;  dpid,&#x000A;  :match => ExactMatch.from( message ),&#x000A;  :buffer_id => message.buffer_id,&#x000A;  :actions => ActionOutput.new( message.in_port + 1 )&#x000A;)&#x000A;</pre>
      <p>This is equivalent with:</p>
      <pre class='brush: ruby'>:match => Match.new(&#x000A;  :in_port = message.in_port,&#x000A;  :nw_src => message.nw_src,&#x000A;  :nw_dst => message.nw_dst,&#x000A;  :tp_src => message.tp_src,&#x000A;  :tp_dst => message.tp_dst,&#x000A;  :dl_src => message.dl_src,&#x000A;    ...&#x000A;)&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Summary: Trema API</h1>
      <ul>
        <li>There are many shortcuts and syntactic sugars in Trema API that can simplify and shorten your code</li>
        <li>
          More details can be found in Ruby API Document
          <a href='http://rubydoc.info/github/trema/trema/'>http://rubydoc.info/github/trema/trema/</a>
        </li>
      </ul>
    </div>
    <div class='slide'>
      <div class='vcenter'>
        <h2>Short Break (15min)</h2>
      </div>
    </div>
    <div class='slide'>
      <h1>Traffic Monitor</h1>
      <ul>
        <li>L2 switch</li>
        <li>Counts the number of packets sent by each user</li>
        <li>Each user is identified by its MAC address</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Traffic Monitor classes</h1>
      <ul>
        <li>
          <span style='background-color: #ffff00'>FDB class</span>
          learns {MAC, switch-port} pair
        </li>
        <li>
          <span style='background-color: #ffff00'>Counter class</span>
          keeps number of packets sent by each user
        </li>
        <li>
          <span style='background-color: #ffff00'>TrafficMonitor class</span>
          acts as a Controller
        </li>
      </ul>
      <br />
      <p>Let's implement them one by one</p>
    </div>
    <div class='slide'>
      <h1>Coding #6: FDB Class</h1>
      <pre class='brush: ruby'># src/examples/traffic_monitor/fdb.rb&#x000A;class FDB&#x000A;  def initialize&#x000A;    @db = {}&#x000A;  end&#x000A;&#x000A;  def lookup mac&#x000A;    @db[ mac ]&#x000A;  end&#x000A;&#x000A;  def learn mac, port_number&#x000A;    @db[ mac ] = port_number&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>FDB Class</h1>
      <pre class='brush: ruby'>% irb&#x000A;> require "fdb"&#x000A;> fdb = FDB.new&#x000A;&#x000A;> fdb.lookup "00:00:00:00:00:01"&#x000A;=> nil&#x000A;&#x000A;> fdb.learn "00:00:00:00:00:01", 1&#x000A;> fdb.lookup "00:00:00:00:00:01"&#x000A;=> 1&#x000A;&#x000A;> fdb.learn "00:00:00:00:00:02", 2&#x000A;> fdb.lookup "00:00:00:00:00:02"&#x000A;=> 2&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Hash in Ruby</h1>
      <pre class='brush: ruby'>% irb&#x000A;> price = { "Mac" => 1000, "iPhone" => 500, "iPad" => 600 }&#x000A;=> { "Mac" => 1000, "iPhone" => 500, "iPad" => 600 }&#x000A;&#x000A;> price[ "iPhone" ]&#x000A;=> 500&#x000A;&#x000A;> price[ "iPad" ]&#x000A;=> 600&#x000A;&#x000A;> price[ "iPod Touch" ]&#x000A;=> nil&#x000A;&#x000A;> price[ "iPod Touch" ] = 300&#x000A;=> 300&#x000A;&#x000A;> price[ "iPod Touch" ]&#x000A;=> 300&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Coding #7: Counter Class</h1>
      <pre class='brush: ruby'># src/examples/traffic_monitor/counter.rb&#x000A;class Counter&#x000A;  def initialize&#x000A;    @db = {}&#x000A;  end&#x000A;&#x000A;  def add mac, packet_count, byte_count&#x000A;    @db[ mac ] ||= { :packet_count => 0, :byte_count => 0 }&#x000A;    @db[ mac ][ :packet_count ] += packet_count&#x000A;    @db[ mac ][ :byte_count ] += byte_count&#x000A;  end&#x000A;&#x000A;  def each_pair &block&#x000A;    @db.each_pair &block&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Counter Class</h1>
      <pre class='brush: ruby'>% irb&#x000A;> require "counter"&#x000A;> counter = Counter.new&#x000A;&#x000A;> counter.add "00:00:00:00:00:01", 1, 100&#x000A;> counter.add "00:00:00:00:00:02", 1, 100&#x000A;> counter.add "00:00:00:00:00:02", 1, 100&#x000A;&#x000A;> counter.each_pair do | mac, counter |&#x000A;>   p mac, counter&#x000A;> end&#x000A;"00:00:00:00:00:01"&#x000A;{:packet_count=>1, :byte_count=>100}&#x000A;"00:00:00:00:00:02"&#x000A;{:packet_count=>2, :byte_count=>200}&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>TrafficMonitor Class Overview</h1>
      <p>TrafficMonitor has the following two handlers</p>
      <ul>
        <li>packet_in: L2 switching. When a packet_in comes, learns its {MAC, switch-port} pair and sends flow_mod</li>
        <li>flow_removed: Counts the packets from each user. This traffic information is piggy-backed with flow_removed messages</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Coding #8: TrafficMonitor#packet_in</h1>
      <pre class='brush: ruby; highlight: [16,17,19]'>class TrafficMonitor < Controller&#x000A;  periodic_timer_event :show_counter, 10&#x000A;&#x000A;  def start&#x000A;    @counter = Counter.new&#x000A;    @fdb = FDB.new&#x000A;  end&#x000A;&#x000A;  def packet_in datapath_id, message&#x000A;    macsa = message.macsa&#x000A;    macda = message.macda&#x000A;&#x000A;    @fdb.learn macsa, message.in_port&#x000A;    @counter.add macsa, 1, message.total_len&#x000A;    out_port = @fdb.lookup( macda )&#x000A;    if out_port&#x000A;      flow_mod datapath_id, macsa, macda, out_port&#x000A;      packet_out datapath_id, message, out_port&#x000A;    else&#x000A;      flood datapath_id, message&#x000A;    end&#x000A;  end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Coding #9: TrafficMonitor#flow_mod</h1>
      <pre class='brush: ruby; highlight: [6]'>  private&#x000A;    ...&#x000A;  def flow_mod datapath_id, macsa, macda, out_port&#x000A;    send_flow_mod_add(&#x000A;      datapath_id,&#x000A;      :hard_timeout => 10,&#x000A;      :match => Match.new(&#x000A;        :dl_src => macsa.to_s,&#x000A;        :dl_dst => macda.to_s&#x000A;      ),&#x000A;      :actions => Trema::ActionOutput.new( out_port )&#x000A;    )&#x000A;  end</pre>
      <p>hard_timeout forces flow-entries to be removed in ten seconds and therefore causes flow_removed</p>
    </div>
    <div class='slide'>
      <h1>Coding #10: TrafficMonitor#packet_out and flood</h1>
      <pre class='brush: ruby; highlight: [9]'>class TrafficMonitor < Controller&#x000A;    ...&#x000A;  private&#x000A;    ...&#x000A;  def packet_out datapath_id, message, out_port&#x000A;    send_packet_out(&#x000A;      datapath_id,&#x000A;      :packet_in => message,&#x000A;      :actions => Trema::ActionOutput.new( out_port )&#x000A;    )&#x000A;  end&#x000A;&#x000A;  def flood datapath_id, message&#x000A;    packet_out datapath_id, message, OFPP_FLOOD&#x000A;  end&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Coding #11: TrafficMonitor#flow_removed</h1>
      <pre class='brush: ruby'>class TrafficMonitor < Controller&#x000A;  ...&#x000A;&#x000A;def flow_removed datapath_id, message&#x000A;  @counter.add(&#x000A;    message.match.dl_src,&#x000A;    message.packet_count,&#x000A;    message.byte_count&#x000A;  )&#x000A;end&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Run Traffic Monitor</h1>
      <p>DSL</p>
      <pre class='brush: ruby'>vswitch { dpid 0xabc }&#x000A;&#x000A;# Add two virtual hosts&#x000A;vhost("host1") {&#x000A;  mac "00:00:00:00:00:01"&#x000A;}&#x000A;vhost("host2") {&#x000A;  mac "00:00:00:00:00:02"&#x000A;}&#x000A;&#x000A;# connect hosts to a switch&#x000A;link "0xabc", "host1"&#x000A;link "0xabc", "host2"&#x000A;</pre>
      <p>Run</p>
      <pre class='brush: ruby'>% ./trema run ./traffic-monitor.rb -c ./traffic-monitor.conf&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Let's Send Packets!</h1>
      <p>Open a new terminal and send packets betweeen host1 and host2:</p>
      <pre class='brush: bash'>% ./trema send_packets --source host1 --dest host2 --n_pkts 10 --pps 10&#x000A;% ./trema send_packets --source host2 --dest host1 --n_pkts 10 --pps 10</pre>
      <p>Then the output will look like:</p>
      <pre class='brush: bash'>  ...&#x000A;00:00:00:00:00:01 10 packets (640 bytes)&#x000A;00:00:00:00:00:02 10 packets (640 bytes)&#x000A;  ...&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <div class='vcenter'>
        <h1>Wrap-up</h1>
      </div>
    </div>
    <div class='slide'>
      <h1>Trema Sample Apps</h1>
      <ul>
        <li>Trema distribution includes various samples (in Ruby and C)</li>
        <li>We recommend to run them and read its source code</li>
      </ul>
      <pre class='brush: plain'>% ls src/examples&#x000A;cbench_switch          dumper            hash_bench&#x000A;hello_trema            learning_switch   list_switches&#x000A;multi_learning_switch  openflow_message  packet_in&#x000A;repeater_hub           switch_info       switch_monitor&#x000A;traffic_monitor&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>trema/apps</h1>
      <p>
        <a href='https://github.com/trema/apps'>https://github.com/trema/apps</a>
      </p>
      <p>"Nearly production-level" apps written in Trema</p>
      <ul>
        <li>routing switch</li>
        <li>load balancer</li>
        <li>topology manager etc. etc...</li>
      </ul>
    </div>
    <div class='slide'>
      <div align='center'>
        <img height='90%' src='./TremaApps.gif' />
      </div>
    </div>
    <div class='slide'>
      <h1>Performance: cbench benchmarks</h1>
      <p>cbench = A controller benchmark that measures flow-setup/sec</p>
      <pre class='brush: plain'>1   switches: fmods/sec:  10627   total = 10.626989 per ms &#x000A;1   switches: fmods/sec:  8184   total = 8.183992 per ms &#x000A;1   switches: fmods/sec:  7542   total = 7.541992 per ms &#x000A;1   switches: fmods/sec:  7852   total = 7.851992 per ms &#x000A;1   switches: fmods/sec:  8243   total = 8.242992 per ms &#x000A;1   switches: fmods/sec:  7807   total = 7.806977 per ms &#x000A;1   switches: fmods/sec:  8484   total = 8.483992 per ms &#x000A;1   switches: fmods/sec:  8401   total = 8.400992 per ms &#x000A;1   switches: fmods/sec:  8129   total = 8.128992 per ms &#x000A;1   switches: fmods/sec:  7853   total = 7.852788 per ms &#x000A;RESULT: 1 switches 9 tests min/max/avg/stdev = 7541.99/8483.99/8054.97/292.12 responses/s</pre>
      <p>About 8,000 flow-setup/sec</p>
    </div>
    <div class='slide'>
      <h1>cbench with C version controller</h1>
      <p>About 14,000 flow-setup/sec</p>
      <pre class='brush: plain'>1   switches: fmods/sec:  8891   total = 8.890991 per ms &#x000A;1   switches: fmods/sec:  14864   total = 14.863985 per ms &#x000A;1   switches: fmods/sec:  14316   total = 14.315986 per ms &#x000A;1   switches: fmods/sec:  14548   total = 14.547985 per ms &#x000A;1   switches: fmods/sec:  14648   total = 14.647956 per ms &#x000A;1   switches: fmods/sec:  13318   total = 13.317987 per ms &#x000A;1   switches: fmods/sec:  14376   total = 14.375986 per ms &#x000A;1   switches: fmods/sec:  13143   total = 13.142987 per ms &#x000A;1   switches: fmods/sec:  14275   total = 14.274986 per ms &#x000A;1   switches: fmods/sec:  14280   total = 14.279986 per ms &#x000A;RESULT: 1 switches 9 tests min/max/avg/stdev = 13142.99/14863.99/14196.43/549.16 responses/s</pre>
      <p>We recommend to write a controller in Ruby at first, then rewrite them with C if need be</p>
    </div>
    <div class='slide'>
      <h1>Unit-Test</h1>
      <ul>
        <li>You can write unit-tests of sending/receiving packets between hosts and flow-table entries of switches etc. with RSpec</li>
        <li>
          The details can be found in
          <span style='background-color: #ffff00'>spec/</span>
          directory
        </li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Unit-Test Example</h1>
      <pre class='brush: ruby'>describe RepeaterHub do&#x000A;  around do | example |&#x000A;    network {&#x000A;      vswitch("switch") { datapath_id "0xabc" }&#x000A;      vhost("host1") { promisc "on" }&#x000A;      vhost("host2") { promisc "on" }&#x000A;      link "switch", "host1"&#x000A;      link "switch", "host2"&#x000A;    }.run( RepeaterHub ) {&#x000A;      example.run&#x000A;    }&#x000A;  end&#x000A;&#x000A;  context "when host1 sends one packet to host2" do&#x000A;    describe "switch" do&#x000A;      before { send_packets "host1", "host2" }&#x000A;      subject { switch( "switch" ) }&#x000A;      it { should have( 1 ).flows }&#x000A;      its( "flows.first.actions" ) { should == "FLOOD" }&#x000A;    end&#x000A;&#x000A;      ...&#x000A;&#x000A;</pre>
    </div>
    <div class='slide'>
      <h1>Summary</h1>
      <p>
        <span style='background-color: #ffff00'>OpenFlow framework Trema</span>
      </p>
      <ul>
        <li>You can write controllers short and run it quickly</li>
        <li>Many examples in src/examples and trema/apps repository</li>
        <li>Pull-requests and bug-reports are welcome!</li>
      </ul>
    </div>
    <div class='slide'>
      <h1>Meta</h1>
      <ul>
        <li>
          Trema HomePage
          <a href='http://trema.github.com/trema/'>http://trema.github.com/trema/</a>
        </li>
        <li>
          Ruby API Document:
          <a href='http://rubydoc.info/github/trema/trema/'>http://rubydoc.info/github/trema/trema/</a>
        </li>
        <li>
          Twitter Account:
          <a href='http://twitter.com/trema_news'>@trema_news</a>
        </li>
      </ul>
    </div>
    <div class='layout' data-name='default'>
      <content></content>
      <div class='footer'>
        <span class='left'>
          <b>Hideyuki Shimonishi, Yasuhito Takamiya, Kazushi Sugyo</b>
        </span>
        <span class='right'>
          Trema on
          <a href='http://github.com/trema/trema/'>github</a>
        </span>
        <span class='left'>CHANGE & OFELIA Summer School 2011</span>
        <span class='right'>
          Twitter
          <a href='http://twitter.com/trema_news'>@trema_news</a>
        </span>
      </div>
    </div>
    <div class='layout nofooter' data-name='alt'>
      <content></content>
    </div>
  </body>
</html>
